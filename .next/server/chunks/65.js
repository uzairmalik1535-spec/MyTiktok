"use strict";exports.id=65,exports.ids=[65],exports.modules={10974:(a,b,c)=>{c.d(b,{BE:()=>h,cn:()=>g});var d=c(85663),e=c(75986),f=c(8974);function g(...a){return(0,f.QP)((0,e.$)(a))}async function h(a,b){return await d.Ay.compare(a,b)}},20561:(a,b,c)=>{c.d(b,{j2:()=>o,Y9:()=>l});var d=c(19443),e=c(10189),f=c(10974),g=c(71682),h=c(32767),i=c(94634);let j=async a=>await g.db.query.users.findFirst({where:(0,i.eq)(h.users.email,a)});async function k(a){try{let b=await g.db.query.users.findFirst({where:(0,i.eq)(h.users.email,a)});return b?.emailVerified==="true"}catch(a){return console.error("Check email verification error:",a),!1}}let{handlers:l,signIn:m,signOut:n,auth:o}=(0,d.Ay)({trustHost:!0,providers:[(0,e.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){try{if(!a?.email||!a?.password)return null;let b=await j(a.email);if(!b)return console.log("User not found"),null;if(!await (0,f.BE)(a.password,b.password))return console.log("Invalid password"),null;if(!await k(a.email))return console.log("Email not verified"),null;return{id:b.id,email:b.email,name:b.name,image:b.image||void 0}}catch(a){return console.error("Error during authentication:",a),null}}})],callbacks:{jwt:async({token:a,user:b})=>(b&&(a.id=b.id,a.email=b.email,a.name=b.name,a.image=b.image),a),session:async({session:a,token:b})=>(b&&(a.user.id=b.id,a.user.email=b.email,a.user.name=b.name,a.user.image=b.image),a)},pages:{signIn:"/"},session:{strategy:"jwt",maxAge:604800},secret:process.env.NEXTAUTH_SECRET})},32767:(a,b,c)=>{c.r(b),c.d(b,{comments:()=>n,commentsRelations:()=>t,likes:()=>o,likesRelations:()=>u,userSessions:()=>q,userSessionsRelations:()=>w,users:()=>l,usersRelations:()=>r,videoViews:()=>p,videoViewsRelations:()=>v,videos:()=>m,videosRelations:()=>s});var d=c(5566),e=c(9594),f=c(29334),g=c(9253),h=c(89697),i=c(63431),j=c(91036),k=c(5614);let l=(0,d.cJ)("users",{id:(0,e.uR)("id").primaryKey().defaultRandom(),email:(0,f.Qq)("email").notNull().unique(),password:(0,f.Qq)("password").notNull(),name:(0,f.Qq)("name").notNull(),image:(0,f.Qq)("image"),emailVerified:(0,f.Qq)("email_verified").default("false"),verificationCode:(0,f.Qq)("verification_code"),verificationCodeExpires:(0,g.vE)("verification_code_expires"),createdAt:(0,g.vE)("created_at").defaultNow().notNull(),updatedAt:(0,g.vE)("updated_at").defaultNow().notNull()},a=>[(0,h.Pe)("email_idx").on(a.email)]),m=(0,d.cJ)("videos",{id:(0,e.uR)("id").primaryKey().defaultRandom(),title:(0,f.Qq)("title").notNull(),description:(0,f.Qq)("description"),url:(0,f.Qq)("url").notNull(),thumbnail:(0,f.Qq)("thumbnail"),duration:(0,i.nd)("duration"),userId:(0,e.uR)("user_id").notNull().references(()=>l.id,{onDelete:"cascade"}),createdAt:(0,g.vE)("created_at").defaultNow().notNull(),updatedAt:(0,g.vE)("updated_at").defaultNow().notNull()},a=>[(0,h.Pe)("videos_user_id_idx").on(a.userId),(0,h.Pe)("videos_created_at_idx").on(a.createdAt)]),n=(0,d.cJ)("comments",{id:(0,e.uR)("id").primaryKey().defaultRandom(),content:(0,f.Qq)("content").notNull(),videoId:(0,e.uR)("video_id").notNull().references(()=>m.id,{onDelete:"cascade"}),userId:(0,e.uR)("user_id").notNull().references(()=>l.id,{onDelete:"cascade"}),createdAt:(0,g.vE)("created_at").defaultNow().notNull(),updatedAt:(0,g.vE)("updated_at").defaultNow().notNull()},a=>[(0,h.Pe)("comments_video_id_idx").on(a.videoId),(0,h.Pe)("comments_user_id_idx").on(a.userId),(0,h.Pe)("comments_created_at_idx").on(a.createdAt)]),o=(0,d.cJ)("likes",{id:(0,e.uR)("id").primaryKey().defaultRandom(),videoId:(0,e.uR)("video_id").notNull().references(()=>m.id,{onDelete:"cascade"}),userId:(0,e.uR)("user_id").notNull().references(()=>l.id,{onDelete:"cascade"}),type:(0,f.Qq)("type").notNull().$type(),createdAt:(0,g.vE)("created_at").defaultNow().notNull()},a=>[(0,h.Pe)("likes_video_id_idx").on(a.videoId),(0,h.Pe)("likes_user_id_idx").on(a.userId),(0,j.Am)("unique_user_video_idx").on(a.userId,a.videoId)]),p=(0,d.cJ)("video_views",{id:(0,e.uR)("id").primaryKey().defaultRandom(),videoId:(0,e.uR)("video_id").notNull().references(()=>m.id,{onDelete:"cascade"}),userId:(0,e.uR)("user_id").references(()=>l.id,{onDelete:"cascade"}),ipAddress:(0,f.Qq)("ip_address"),userAgent:(0,f.Qq)("user_agent"),viewedAt:(0,g.vE)("viewed_at").defaultNow().notNull()},a=>[(0,h.Pe)("video_views_video_id_idx").on(a.videoId),(0,h.Pe)("video_views_user_id_idx").on(a.userId),(0,h.Pe)("video_views_viewed_at_idx").on(a.viewedAt)]),q=(0,d.cJ)("user_sessions",{id:(0,e.uR)("id").primaryKey().defaultRandom(),userId:(0,e.uR)("user_id").notNull().references(()=>l.id,{onDelete:"cascade"}),sessionToken:(0,f.Qq)("session_token").notNull().unique(),expires:(0,g.vE)("expires").notNull(),createdAt:(0,g.vE)("created_at").defaultNow().notNull()},a=>[(0,h.Pe)("user_sessions_user_id_idx").on(a.userId),(0,h.Pe)("user_sessions_token_idx").on(a.sessionToken)]),r=(0,k.K1)(l,({many:a})=>({videos:a(m),comments:a(n),likes:a(o),sessions:a(q)})),s=(0,k.K1)(m,({one:a,many:b})=>({user:a(l,{fields:[m.userId],references:[l.id]}),comments:b(n),likes:b(o),views:b(p)})),t=(0,k.K1)(n,({one:a,many:b})=>({video:a(m,{fields:[n.videoId],references:[m.id]}),user:a(l,{fields:[n.userId],references:[l.id]}),replies:b(n)})),u=(0,k.K1)(o,({one:a})=>({video:a(m,{fields:[o.videoId],references:[m.id]}),user:a(l,{fields:[o.userId],references:[l.id]})})),v=(0,k.K1)(p,({one:a})=>({video:a(m,{fields:[p.videoId],references:[m.id]}),user:a(l,{fields:[p.userId],references:[l.id]})})),w=(0,k.K1)(q,({one:a})=>({user:a(l,{fields:[q.userId],references:[l.id]})}))},71682:(a,b,c)=>{c.d(b,{db:()=>h});var d=c(88909),e=c(3250),f=c(32767);let g=(0,d.lw)(process.env.DATABASE_URL),h=(0,e.fd)({client:g,schema:f})},73137:(a,b,c)=>{c.d(b,{Rt:()=>m,fV:()=>l,fY:()=>i});var d=c(71682),e=c(32767),f=c(96657),g=c(94634),h=c(16048);let i=async({limit:a=20,cursor:b,userId:c})=>{try{let i=d.db.select({id:e.videos.id,title:e.videos.title,description:e.videos.description,url:e.videos.url,thumbnail:e.videos.thumbnail,userId:e.videos.userId,createdAt:e.videos.createdAt,updatedAt:e.videos.updatedAt,userName:e.users.name,userEmail:e.users.email,userImage:e.users.image,likeCount:(0,f.ll)`(
          SELECT COUNT(*)::int 
          FROM ${e.likes} l 
          WHERE l.video_id = ${e.videos.id} AND l.type = 'like'
        )`,dislikeCount:(0,f.ll)`(
          SELECT COUNT(*)::int 
          FROM ${e.likes} l 
          WHERE l.video_id = ${e.videos.id} AND l.type = 'dislike'
        )`,commentsCount:(0,f.ll)`(
          SELECT COUNT(*)::int 
          FROM ${e.comments} c 
          WHERE c.video_id = ${e.videos.id}
        )`,userLikeType:c?(0,f.ll)`(
              SELECT l.type 
              FROM ${e.likes} l 
              WHERE l.video_id = ${e.videos.id} AND l.user_id = ${c}
              LIMIT 1
            )`:(0,f.ll)`NULL`}).from(e.videos).innerJoin(e.users,(0,g.eq)(e.videos.userId,e.users.id)),j=b?i.where((0,g.lt)(e.videos.createdAt,b)):i,k=await j.orderBy((0,h.i)(e.videos.createdAt)).limit(a+1),l=k.length>a,m=l?k.slice(0,a):k,n=m.map(a=>({id:a.id,title:a.title,description:a.description,url:a.url,thumbnail:a.thumbnail,userId:a.userId,createdAt:a.createdAt,updatedAt:a.updatedAt,user:{id:a.userId,name:a.userName,email:a.userEmail,image:a.userImage},userLike:a.userLikeType,likeCount:a.likeCount,dislikeCount:a.dislikeCount,commentCount:a.commentsCount})),o=l?m[m.length-1].createdAt:null;return{videos:n,nextCursor:o,hasNextPage:l}}catch(a){return console.error("Get videos query error:",a),{videos:[],nextCursor:null,hasNextPage:!1}}},j=async a=>await d.db.query.videos.findFirst({where:(0,g.eq)(e.videos.id,a),with:{user:!0}}),k=async(a,b)=>await d.db.query.likes.findFirst({where:(0,g.Uo)((0,g.eq)(e.likes.videoId,a),(0,g.eq)(e.likes.userId,b))}),l=async(a,b)=>{try{if(!await j(a))return{error:"Video not found"};let c=await k(a,b);if(!c)return await d.db.insert(e.likes).values({videoId:a,userId:b,type:"like"}),{success:!0,action:"added",type:"like"};if("like"===c.type)return await d.db.delete(e.likes).where((0,g.eq)(e.likes.id,c.id)),{success:!0,action:"removed",type:"like"};return await d.db.update(e.likes).set({type:"like"}).where((0,g.eq)(e.likes.id,c.id)),{success:!0,action:"changed",type:"like"}}catch(a){return console.error("Like video error:",a),{error:"Failed to like video"}}},m=async(a,b)=>{try{if(!await j(a))return{error:"Video not found"};let c=await k(a,b);if(!c)return await d.db.insert(e.likes).values({videoId:a,userId:b,type:"dislike"}),{success:!0,action:"added",type:"dislike"};if("dislike"===c.type)return await d.db.delete(e.likes).where((0,g.eq)(e.likes.id,c.id)),{success:!0,action:"removed",type:"dislike"};return await d.db.update(e.likes).set({type:"dislike"}).where((0,g.eq)(e.likes.id,c.id)),{success:!0,action:"changed",type:"dislike"}}catch(a){return console.error("Dislike video error:",a),{error:"Failed to dislike video"}}}}};